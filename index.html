<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board Game Night Organizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button.danger {
            background: #e74c3c;
        }
        
        button.danger:hover {
            background: #c0392b;
        }
        
        button.secondary {
            background: #95a5a6;
        }
        
        button.secondary:hover {
            background: #7f8c8d;
        }
        
        .game-list {
            display: grid;
            gap: 15px;
        }
        
        .game-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            position: relative;
        }
        
        .game-item .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }
        
        .game-item .delete-btn:hover {
            background: #c0392b;
        }
        
        .game-item .edit-link-btn {
            position: absolute;
            top: 10px;
            right: 80px;
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }
        
        .game-item .edit-link-btn:hover {
            background: #2980b9;
        }
        
        .admin-mode .game-item .delete-btn,
        .admin-mode .game-item .edit-link-btn {
            display: block;
        }
        
        .game-item .bgg-link {
            display: inline-block;
            margin-top: 8px;
            color: #667eea;
            text-decoration: none;
            font-size: 13px;
        }
        
        .game-item .bgg-link:hover {
            text-decoration: underline;
        }
        
        .voting-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .voting-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .voting-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }
        
        .voting-card.selected {
            border-color: #667eea;
            background: #e8eaf6;
        }
        
        .voting-card .rank-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .voting-card.selected .rank-badge {
            display: flex;
        }
        
        .voting-card h4 {
            color: #333;
            margin-bottom: 8px;
            margin-right: 40px;
        }
        
        .voting-card .card-detail {
            color: #666;
            font-size: 13px;
            margin: 4px 0;
        }
        
        .game-night-info {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .game-night-info h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        .game-night-info .info-detail {
            font-size: 16px;
            color: #333;
            margin: 5px 0;
        }
        
        @media (max-width: 1200px) {
            .voting-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .voting-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .voting-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .game-item h3 {
            color: #333;
            margin-bottom: 8px;
        }
        
        .game-detail {
            color: #666;
            font-size: 14px;
            margin: 4px 0;
        }
        
        .rank-selector {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .rank-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .rank-item label {
            min-width: 100px;
            margin: 0;
        }
        
        .rank-item select {
            flex: 1;
        }
        
        .winner-section {
            background: #fff9e6;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ffd700;
            margin-top: 20px;
        }
        
        .winner-section h3 {
            color: #f39c12;
            margin-bottom: 15px;
        }
        
        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .player-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
        }
        
        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .history-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .admin-controls {
            display: grid;
            gap: 15px;
        }
        
        .voting-status {
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .voting-open {
            background: #d4edda;
            color: #155724;
        }
        
        .voting-closed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .overflow-indicator {
            color: #e74c3c;
            font-size: 13px;
            font-style: italic;
            margin-top: 4px;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≤ Board Game Night Organizer</h1>
        
        <!-- Voting -->
        <div class="section">
            <h2>üó≥Ô∏è Vote for This Week's Games</h2>
            
            <!-- Game Night Info -->
            <div id="gameNightInfo" class="game-night-info"></div>
            
            <div id="votingWarning" class="warning" style="display: none;"></div>
            <div class="form-group">
                <label for="voterName">Your Name:</label>
                <input type="text" id="voterName" placeholder="Enter your name">
            </div>
            
            <p style="margin: 15px 0; color: #666;">Click on 3 games in order of preference (1st, 2nd, 3rd choice):</p>
            
            <div id="votingGrid" class="voting-grid"></div>
            
            <button onclick="submitVote()" style="margin-top: 20px;">Submit Vote</button>
        </div>
        
        <!-- This Week's Games -->
        <div class="section">
            <h2>üèÜ This Week's Top Games</h2>
            <div id="topGames"></div>
        </div>
        
        <!-- Add Games -->
        <div class="section">
            <h2>‚ûï Add a Game</h2>
            <div class="form-group">
                <label for="ownerName">Your Name:</label>
                <input type="text" id="ownerName" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label for="gameName">Game Name:</label>
                <input type="text" id="gameName" placeholder="Enter game name">
            </div>
            <div class="form-group">
                <label for="bggLink">BoardGameGeek Link (optional):</label>
                <input type="text" id="bggLink" placeholder="https://boardgamegeek.com/boardgame/...">
            </div>
            <div class="two-column">
                <div class="form-group">
                    <label for="minPlayers">Min Players:</label>
                    <input type="number" id="minPlayers" min="1" value="2">
                </div>
                <div class="form-group">
                    <label for="maxPlayers">Max Players:</label>
                    <input type="number" id="maxPlayers" min="1" value="4">
                </div>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="canTeach">
                    I can teach this game
                </label>
            </div>
            <button onclick="addGame()">Add Game</button>
        </div>
        
        <!-- History -->
        <div class="section">
            <h2>üìú Game Night History</h2>
            <div id="winnerRecordingSection" class="winner-section" style="display: none;">
                <h3>Record Winner for Current Week</h3>
                <div class="form-group">
                    <label for="winnerGame">Select Game:</label>
                    <select id="winnerGame">
                        <option value="">Select a game</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="winnerName">Winner Name:</label>
                    <input type="text" id="winnerName" placeholder="Enter winner's name">
                </div>
                <div class="form-group">
                    <label for="winnerDate">Date Played:</label>
                    <input type="date" id="winnerDate">
                </div>
                <button onclick="recordWinner()">Record Winner</button>
            </div>
            
            <div id="historyList" style="margin-top: 20px;"></div>
        </div>
        
        <!-- Admin Controls -->
        <div class="section">
            <h2>‚öôÔ∏è Admin Controls</h2>
            <div id="adminLogin" style="display: block;">
                <div class="form-group">
                    <label for="adminPassword">Admin Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password">
                </div>
                <button onclick="adminLogin()">Login as Admin</button>
            </div>
            <div id="adminPanel" style="display: none;">
                <div style="background: #d4edda; padding: 10px; border-radius: 6px; margin-bottom: 15px; color: #155724;">
                    ‚úì Logged in as Admin
                    <button onclick="adminLogout()" class="secondary" style="float: right; padding: 6px 12px;">Logout</button>
                </div>
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="gameNightDate">Game Night Date:</label>
                        <input type="date" id="gameNightDate">
                    </div>
                    <div class="form-group">
                        <label for="votingDeadline">Voting Deadline:</label>
                        <input type="date" id="votingDeadline">
                    </div>
                    <button onclick="saveGameNightDates()">Set Dates</button>
                    <button class="danger" onclick="resetForNewWeek()">Reset for New Week</button>
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="newAdminPassword">Change Admin Password:</label>
                        <input type="password" id="newAdminPassword" placeholder="Enter new password">
                        <button onclick="changeAdminPassword()" style="margin-top: 10px;">Update Password</button>
                    </div>
                </div>
            </div>
            <div id="votingStatus" class="voting-status"></div>
        </div>
    </div>

    <script>
        // Google Sheets API endpoint
        const SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbxgHEzu3nPSeGfYFPUwZT38CgTG3kHJBEcPvVxfKhKucx-pe1rVDos8dJkq9F7oA2Su/exec';

        // Initialize data structure
        let gameData = {
            games: [],
            votes: [],
            history: [],
            votingDeadline: null,
            gameNightDate: null,
            adminPassword: null
        };

        let isAdminLoggedIn = false;
        let selectedVotes = [null, null, null]; // Track 1st, 2nd, 3rd choices

        // Load data from Google Sheets
        async function loadData() {
            try {
                const response = await fetch(SHEETS_API_URL + '?action=getData');
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Convert votes back to proper format
                    const votes = (result.data.votes || []).map(vote => ({
                        voterName: vote.voterName,
                        choices: [
                            parseInt(vote.choice1),
                            parseInt(vote.choice2),
                            parseInt(vote.choice3)
                        ]
                    }));
                    
                    gameData = {
                        games: result.data.games || [],
                        votes: votes,
                        history: result.data.history || [],
                        votingDeadline: result.data.settings.votingDeadline || getNextTuesday(),
                        gameNightDate: result.data.settings.gameNightDate || getNextWednesday(),
                        adminPassword: result.data.settings.adminPassword || 'admin123'
                    };
                    
                    console.log('Data loaded from Google Sheets:', gameData);
                } else {
                    console.error('Failed to load data:', result);
                    gameData.adminPassword = 'admin123';
                    gameData.votingDeadline = getNextTuesday();
                    gameData.gameNightDate = getNextWednesday();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error connecting to Google Sheets. Please check your internet connection.');
                gameData.adminPassword = 'admin123';
                gameData.votingDeadline = getNextTuesday();
                gameData.gameNightDate = getNextWednesday();
            }
            updateAllDisplays();
        }

        // Helper function to get next Tuesday
        function getNextTuesday() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysUntilTuesday = (2 - dayOfWeek + 7) % 7 || 7;
            const nextTuesday = new Date(today);
            nextTuesday.setDate(today.getDate() + daysUntilTuesday);
            return nextTuesday.toISOString().split('T')[0];
        }

        // Helper function to get next Wednesday
        function getNextWednesday() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysUntilWednesday = (3 - dayOfWeek + 7) % 7 || 7;
            const nextWednesday = new Date(today);
            nextWednesday.setDate(today.getDate() + daysUntilWednesday);
            return nextWednesday.toISOString().split('T')[0];
        }

        // Admin login
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === gameData.adminPassword) {
                isAdminLoggedIn = true;
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('winnerRecordingSection').style.display = 'block';
                document.getElementById('adminPassword').value = '';
                
                // Show a notice about changing the default password
                if (gameData.adminPassword === 'admin123') {
                    alert('‚ö†Ô∏è You are using the default password "admin123". Please change it below for security!');
                }
            } else {
                alert('Incorrect password');
                document.getElementById('adminPassword').value = '';
            }
        }

        // Admin logout
        function adminLogout() {
            isAdminLoggedIn = false;
            document.getElementById('adminLogin').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('winnerRecordingSection').style.display = 'none';
        }

        // Change admin password (optimistic update)
        async function changeAdminPassword() {
            const newPassword = document.getElementById('newAdminPassword').value.trim();
            
            if (!newPassword) {
                alert('Please enter a new password');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }
            
            gameData.adminPassword = newPassword;
            document.getElementById('newAdminPassword').value = '';
            alert('Admin password updated successfully!');
            
            // Save in background (don't await)
            saveData();
        }

        // Save data to Google Sheets (batched - single API call)
        async function saveData() {
            try {
                const response = await fetch(SHEETS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'saveAll',
                        games: JSON.stringify(gameData.games),
                        votes: JSON.stringify(gameData.votes),
                        history: JSON.stringify(gameData.history),
                        settings: JSON.stringify({
                            votingDeadline: gameData.votingDeadline,
                            gameNightDate: gameData.gameNightDate,
                            adminPassword: gameData.adminPassword
                        })
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    console.error('Save failed:', result);
                }
                
                console.log('Data saved to Google Sheets');
            } catch (error) {
                console.error('Error saving data:', error);
                // Don't show alert - save happens in background now
            }
        }

        // Check if voting is open
        function isVotingOpen() {
            if (!gameData.votingDeadline) return true;
            const deadline = new Date(gameData.votingDeadline);
            const now = new Date();
            return now < deadline;
        }

        // Update voting status display
        function updateVotingStatus() {
            const statusDiv = document.getElementById('votingStatus');
            const warningDiv = document.getElementById('votingWarning');
            const votingDeadlineInput = document.getElementById('votingDeadline');
            const gameNightDateInput = document.getElementById('gameNightDate');
            
            console.log('updateVotingStatus called, deadline:', gameData.votingDeadline);
            
            // Update the input fields with current dates
            if (gameData.votingDeadline) {
                votingDeadlineInput.value = gameData.votingDeadline;
            }
            if (gameData.gameNightDate) {
                gameNightDateInput.value = gameData.gameNightDate;
            }
            
            if (!gameData.votingDeadline) {
                statusDiv.className = 'voting-status voting-open';
                statusDiv.textContent = 'Voting is OPEN (no deadline set)';
                warningDiv.style.display = 'none';
            } else {
                const deadline = new Date(gameData.votingDeadline);
                console.log('Deadline date object:', deadline);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateStr = deadline.toLocaleDateString('en-US', options);
                
                if (isVotingOpen()) {
                    statusDiv.className = 'voting-status voting-open';
                    statusDiv.textContent = `Voting is OPEN until ${dateStr}`;
                    warningDiv.style.display = 'none';
                } else {
                    statusDiv.className = 'voting-status voting-closed';
                    statusDiv.textContent = `Voting CLOSED on ${dateStr}`;
                    warningDiv.style.display = 'block';
                    warningDiv.textContent = 'Voting is currently closed. Contact the organizer to reopen voting.';
                }
            }
        }

        // Save game night dates (optimistic update)
        async function saveGameNightDates() {
            if (!isAdminLoggedIn) {
                alert('Admin access required');
                return;
            }
            
            const gameNightDate = document.getElementById('gameNightDate').value;
            const votingDeadline = document.getElementById('votingDeadline').value;
            
            if (!gameNightDate || !votingDeadline) {
                alert('Please select both dates');
                return;
            }
            
            gameData.gameNightDate = gameNightDate;
            gameData.votingDeadline = votingDeadline;
            
            // Optimistic update - refresh UI immediately
            displayGameNightInfo();
            updateVotingStatus();
            alert('Dates updated successfully!');
            
            // Save in background (don't await)
            saveData().catch(error => {
                console.error('Failed to save dates:', error);
            });
        }

        // Add a game (optimistic update)
        async function addGame() {
            const ownerName = document.getElementById('ownerName').value.trim();
            const gameName = document.getElementById('gameName').value.trim();
            const bggLink = document.getElementById('bggLink').value.trim();
            const minPlayers = parseInt(document.getElementById('minPlayers').value);
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
            const canTeach = document.getElementById('canTeach').checked;

            if (!ownerName || !gameName) {
                alert('Please enter both your name and game name');
                return;
            }

            if (minPlayers > maxPlayers) {
                alert('Min players cannot be greater than max players');
                return;
            }

            // Check if game already exists
            const existingGame = gameData.games.find(g => g.name.toLowerCase() === gameName.toLowerCase());
            
            if (existingGame) {
                // Add owner to existing game
                if (!existingGame.owners.find(o => o.name.toLowerCase() === ownerName.toLowerCase())) {
                    existingGame.owners.push({ name: ownerName, canTeach: canTeach });
                    // Update BGG link if provided and not already set
                    if (bggLink && !existingGame.bggLink) {
                        existingGame.bggLink = bggLink;
                    }
                } else {
                    alert(`${ownerName} is already listed as an owner of ${gameName}`);
                    return;
                }
            } else {
                // Create new game
                const game = {
                    id: Date.now(),
                    name: gameName,
                    bggLink: bggLink || null,
                    owners: [{ name: ownerName, canTeach: canTeach }],
                    minPlayers: minPlayers,
                    maxPlayers: maxPlayers
                };
                gameData.games.push(game);
            }

            // Clear form
            document.getElementById('ownerName').value = '';
            document.getElementById('gameName').value = '';
            document.getElementById('bggLink').value = '';
            document.getElementById('minPlayers').value = '2';
            document.getElementById('maxPlayers').value = '4';
            document.getElementById('canTeach').checked = false;

            // Optimistic update - refresh UI immediately
            updateAllDisplays();
            
            // Save in background (don't await)
            saveData();
        }

        // Edit BGG link for a game (admin only)
        async function editBGGLink(gameId) {
            if (!isAdminLoggedIn) {
                alert('Admin access required');
                return;
            }

            const game = gameData.games.find(g => g.id === gameId);
            if (!game) return;

            const newLink = prompt(`Enter BoardGameGeek link for "${game.name}":`, game.bggLink || '');
            if (newLink === null) return; // User cancelled

            game.bggLink = newLink.trim() || null;

            // Optimistic update - refresh UI immediately
            displayGames();
            displayVotingGrid();
            
            // Save in background
            saveData();
        }

        // Display game night info
        function displayGameNightInfo() {
            const infoDiv = document.getElementById('gameNightInfo');
            
            const gameNightDate = new Date(gameData.gameNightDate);
            const votingDeadline = new Date(gameData.votingDeadline);
            
            const gameNightStr = gameNightDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const votingDeadlineStr = votingDeadline.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            infoDiv.innerHTML = `
                <h3>üìÖ Next Game Night</h3>
                <div class="info-detail"><strong>${gameNightStr}</strong></div>
                <div class="info-detail" style="margin-top: 10px;">Voting closes: ${votingDeadlineStr}</div>
            `;
        }

        // Delete a game (admin only, optimistic update)
        async function deleteGame(gameId) {
            if (!isAdminLoggedIn) {
                alert('Admin access required');
                return;
            }

            const game = gameData.games.find(g => g.id === gameId);
            if (!game) return;

            if (!confirm(`Are you sure you want to delete "${game.name}"?`)) {
                return;
            }

            // Remove the game
            gameData.games = gameData.games.filter(g => g.id !== gameId);

            // Remove any votes for this game
            gameData.votes = gameData.votes.map(vote => {
                const newChoices = vote.choices.filter(choice => choice !== gameId);
                // If we removed choices, we need to handle that
                if (newChoices.length < vote.choices.length) {
                    // Pad with null values if needed
                    while (newChoices.length < 3) {
                        newChoices.push(null);
                    }
                }
                return {
                    ...vote,
                    choices: newChoices
                };
            }).filter(vote => vote.choices.some(c => c !== null)); // Remove votes with no valid choices

            // Optimistic update - refresh UI immediately
            updateAllDisplays();
            
            // Save in background (don't await)
            saveData();
        }

        // Display games list
        // Display voting grid
        function displayVotingGrid() {
            const gridDiv = document.getElementById('votingGrid');
            
            if (gameData.games.length === 0) {
                gridDiv.innerHTML = '<p style="color: #999;">No games available to vote on</p>';
                return;
            }

            gridDiv.innerHTML = gameData.games.map(game => {
                const ownersList = game.owners.map(o => 
                    `${o.name}${o.canTeach ? ' üë®‚Äçüè´' : ''}`
                ).join(', ');

                const bggLinkHtml = game.bggLink 
                    ? `<div class="card-detail"><a href="${game.bggLink}" target="_blank" style="color: #667eea;">View Rules</a></div>` 
                    : '';

                // Check if this game is selected
                const rank = selectedVotes.indexOf(game.id) + 1;
                const selectedClass = rank > 0 ? 'selected' : '';

                return `
                    <div class="voting-card ${selectedClass}" onclick="selectGame(${game.id})">
                        <div class="rank-badge">${rank}</div>
                        <h4>${game.name}</h4>
                        <div class="card-detail">üë• ${game.minPlayers}-${game.maxPlayers} players</div>
                        <div class="card-detail">üé≤ ${ownersList}</div>
                        ${bggLinkHtml}
                    </div>
                `;
            }).join('');
        }

        // Select a game for voting
        function selectGame(gameId) {
            const currentIndex = selectedVotes.indexOf(gameId);
            
            if (currentIndex >= 0) {
                // Game is already selected - deselect it
                selectedVotes[currentIndex] = null;
            } else {
                // Find the first available slot
                const emptySlot = selectedVotes.indexOf(null);
                if (emptySlot >= 0) {
                    selectedVotes[emptySlot] = gameId;
                } else {
                    alert('You can only select 3 games. Deselect one first.');
                    return;
                }
            }
            
            // Refresh the grid
            displayVotingGrid();
        }

        // Update vote dropdowns (legacy - keeping for backward compatibility with winner dropdown)
        function updateVoteDropdowns() {
            // Update winner dropdown
            const winnerSelect = document.getElementById('winnerGame');
            const currentWinnerValue = winnerSelect.value;
            winnerSelect.innerHTML = '<option value="">Select a game</option>';
            
            const topGames = calculateTopGames();
            topGames.forEach(gameResult => {
                const option = document.createElement('option');
                option.value = gameResult.game.id;
                option.textContent = gameResult.game.name;
                winnerSelect.appendChild(option);
            });
            
            winnerSelect.value = currentWinnerValue;
        }

        // Submit vote (optimistic update)
        async function submitVote() {
            if (!isVotingOpen()) {
                alert('Voting is currently closed!');
                return;
            }

            const voterName = document.getElementById('voterName').value.trim();

            if (!voterName) {
                alert('Please enter your name');
                return;
            }

            // Check if user selected 3 games
            const validChoices = selectedVotes.filter(id => id !== null);
            if (validChoices.length !== 3) {
                alert('Please select exactly 3 games');
                return;
            }

            // Remove existing vote from this person
            gameData.votes = gameData.votes.filter(v => v.voterName.toLowerCase() !== voterName.toLowerCase());

            // Add new vote
            const vote = {
                voterName: voterName,
                choices: [...selectedVotes]
            };

            gameData.votes.push(vote);

            // Clear form and selections
            document.getElementById('voterName').value = '';
            selectedVotes = [null, null, null];

            // Optimistic update - refresh UI immediately
            updateAllDisplays();
            alert('Vote submitted successfully!');
            
            // Save in background (don't await)
            saveData();
        }

        // Calculate top games with spillover
        function calculateTopGames() {
            if (gameData.games.length === 0 || gameData.votes.length === 0) {
                return [];
            }

            // Count votes using ranked choice
            const gameScores = {};
            gameData.games.forEach(game => {
                gameScores[game.id] = { score: 0, voters: [] };
            });

            gameData.votes.forEach(vote => {
                vote.choices.forEach((gameId, index) => {
                    const points = [3, 2, 1][index]; // 1st choice = 3 points, 2nd = 2, 3rd = 1
                    gameScores[gameId].score += points;
                    gameScores[gameId].voters.push({
                        name: vote.voterName,
                        rank: index + 1,
                        choices: vote.choices
                    });
                });
            });

            // Sort by score
            const sortedGames = Object.entries(gameScores)
                .map(([gameId, data]) => ({
                    game: gameData.games.find(g => g.id === parseInt(gameId)),
                    score: data.score,
                    voters: data.voters
                }))
                .filter(item => item.game && item.score > 0)
                .sort((a, b) => b.score - a.score);

            // Get top 3
            const top3 = sortedGames.slice(0, 3);

            // Apply spillover logic
            top3.forEach(gameResult => {
                const assignedPlayers = [];
                const overflowPlayers = [];

                // Sort voters by rank (1st choice voters get priority)
                const sortedVoters = [...gameResult.voters].sort((a, b) => a.rank - b.rank);

                sortedVoters.forEach(voter => {
                    if (assignedPlayers.length < gameResult.game.maxPlayers) {
                        assignedPlayers.push(voter.name);
                    } else {
                        // Find their next choice that's in top 3 and not full
                        let assigned = false;
                        for (let i = voter.rank; i < 3; i++) {
                            const nextChoiceId = voter.choices[i];
                            const nextGame = top3.find(g => g.game.id === nextChoiceId);
                            
                            if (nextGame && nextGame !== gameResult) {
                                if (!nextGame.assignedPlayers) nextGame.assignedPlayers = [];
                                if (!nextGame.overflowPlayers) nextGame.overflowPlayers = [];
                                
                                if (nextGame.assignedPlayers.length < nextGame.game.maxPlayers &&
                                    !nextGame.assignedPlayers.includes(voter.name)) {
                                    nextGame.assignedPlayers.push(voter.name);
                                    assigned = true;
                                    overflowPlayers.push(`${voter.name} (moved to ${nextGame.game.name})`);
                                    break;
                                }
                            }
                        }
                        if (!assigned) {
                            overflowPlayers.push(`${voter.name} (no available slot)`);
                        }
                    }
                });

                gameResult.assignedPlayers = assignedPlayers;
                gameResult.overflowPlayers = overflowPlayers;
            });

            return top3;
        }

        // Display top games
        function displayTopGames() {
            const topGamesDiv = document.getElementById('topGames');
            const topGames = calculateTopGames();

            if (topGames.length === 0) {
                topGamesDiv.innerHTML = '<p style="color: #999;">No votes yet</p>';
                return;
            }

            topGamesDiv.innerHTML = topGames.map((gameResult, index) => {
                const ownersList = gameResult.game.owners.map(o => 
                    `${o.name}${o.canTeach ? ' üë®‚Äçüè´' : ''}`
                ).join(', ');

                const players = gameResult.assignedPlayers || [];
                const overflow = gameResult.overflowPlayers || [];

                return `
                    <div class="game-item" style="border-left-color: ${['#ffd700', '#c0c0c0', '#cd7f32'][index]};">
                        <h3>${index + 1}. ${gameResult.game.name} (${gameResult.score} points)</h3>
                        <div class="game-detail">Brought by: ${ownersList}</div>
                        <div class="game-detail">Players: ${gameResult.game.minPlayers}-${gameResult.game.maxPlayers}</div>
                        <div class="game-detail">
                            <strong>Playing (${players.length}/${gameResult.game.maxPlayers}):</strong>
                            <div class="player-list">
                                ${players.map(p => `<span class="player-badge">${p}</span>`).join('')}
                            </div>
                        </div>
                        ${overflow.length > 0 ? `
                            <div class="overflow-indicator">
                                Spillover: ${overflow.join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Record winner (optimistic update)
        async function recordWinner() {
            if (!isAdminLoggedIn) {
                alert('Admin access required');
                return;
            }
            
            const gameId = document.getElementById('winnerGame').value;
            const winnerName = document.getElementById('winnerName').value.trim();
            const winnerDate = document.getElementById('winnerDate').value;

            if (!gameId || !winnerName || !winnerDate) {
                alert('Please fill in all fields');
                return;
            }

            const game = gameData.games.find(g => g.id === parseInt(gameId));
            if (!game) {
                alert('Game not found');
                return;
            }

            const historyEntry = {
                id: Date.now(),
                gameName: game.name,
                winner: winnerName,
                date: winnerDate
            };

            gameData.history.push(historyEntry);

            // Clear form
            document.getElementById('winnerGame').value = '';
            document.getElementById('winnerName').value = '';
            document.getElementById('winnerDate').value = '';

            // Optimistic update - refresh UI immediately
            displayHistory();
            alert('Winner recorded successfully!');
            
            // Save in background (don't await)
            saveData();
        }

        // Display history
        function displayHistory() {
            const historyDiv = document.getElementById('historyList');
            
            if (gameData.history.length === 0) {
                historyDiv.innerHTML = '<p style="color: #999;">No game history yet</p>';
                return;
            }

            // Sort by date descending
            const sortedHistory = [...gameData.history].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            historyDiv.innerHTML = sortedHistory.map(entry => {
                const date = new Date(entry.date);
                const dateStr = date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });

                return `
                    <div class="history-item">
                        <h4>üèÜ ${entry.gameName}</h4>
                        <div class="game-detail">Winner: <strong>${entry.winner}</strong></div>
                        <div class="game-detail">Date: ${dateStr}</div>
                    </div>
                `;
            }).join('');
        }

        // Reset for new week (optimistic update)
        async function resetForNewWeek() {
            if (!isAdminLoggedIn) {
                alert('Admin access required');
                return;
            }
            
            if (!confirm('This will clear all games and votes for the new week. History will be preserved. Continue?')) {
                return;
            }

            gameData.games = [];
            gameData.votes = [];
            gameData.votingDeadline = getNextTuesday();
            gameData.gameNightDate = getNextWednesday();

            // Optimistic update - refresh UI immediately
            updateAllDisplays();
            alert('Reset complete! Ready for a new week.');
            
            // Save in background (don't await)
            saveData();
        }

        // Update all displays
        function updateAllDisplays() {
            displayGameNightInfo();
            displayVotingGrid();
            updateVoteDropdowns();
            displayTopGames();
            displayHistory();
            updateVotingStatus();
            
            // Set today's date as default for winner recording
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('winnerDate').value = today;
        }

        // Initialize on load
        window.addEventListener('load', () => {
            loadData();
            
            // Auto-refresh data every 10 seconds to stay in sync
            setInterval(async () => {
                if (!isAdminLoggedIn) { // Don't refresh while admin is making changes
                    await loadData();
                }
            }, 10000);
        });
    </script>
</body>
</html>
